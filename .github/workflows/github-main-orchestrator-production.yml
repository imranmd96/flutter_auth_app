name: 'GitHub CI/CD: Main Orchestrator - Production (Hybrid Approach)'

on:
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment of all services'
        required: false
        default: 'false'
        type: boolean
      deploy_services:
        description: 'Comma-separated list of services to deploy (or "all")'
        required: false
        default: ''
        type: string
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: forkline
  PRODUCTION_DOMAIN: forkline.com

permissions:
  contents: read
  actions: read
  security-events: write
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed-services: ${{ steps.changes.outputs.services }}
      changed-services-json: ${{ steps.changes.outputs.services_json }}
      all-services: ${{ steps.changes.outputs.all_services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: backend/**

      - name: Detect changed services
        id: changes
        run: |
          # All available services
          ALL_SERVICES="api-gateway,auth-service,payment-service,chat-service,notification-service,user-service,review-service,loyalty-service,media-service,restaurant-service,analytics-service,inventory-service,menu-service,search-service,order-service,booking-service,geolocation-service"
          
          # Detect changed services
          changed_services=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if [[ $file =~ ^backend/([^/]+) ]]; then
              service="${BASH_REMATCH[1]}"
              if [[ ! "$changed_services" =~ $service ]]; then
                changed_services="$changed_services,$service"
              fi
            fi
          done
          
          # Remove leading comma
          changed_services="${changed_services#,}"
          
          # Handle force deploy or specific services
          if [[ "${{ inputs.force_deploy }}" == "true" || "${{ inputs.deploy_services }}" == "all" ]]; then
            changed_services="$ALL_SERVICES"
          elif [[ "${{ inputs.deploy_services }}" != "" && "${{ inputs.deploy_services }}" != "all" ]]; then
            changed_services="${{ inputs.deploy_services }}"
          fi
          
          # Convert to JSON array format
          if [[ -n "$changed_services" ]]; then
            # Split by comma and create JSON array
            IFS=',' read -ra SERVICES <<< "$changed_services"
            services_json="["
            for i in "${!SERVICES[@]}"; do
              if [[ $i -gt 0 ]]; then
                services_json+=","
              fi
              services_json+="\"${SERVICES[$i]}\""
            done
            services_json+="]"
          else
            services_json="[]"
          fi
          
          echo "services=$changed_services" >> $GITHUB_OUTPUT
          echo "services_json=$services_json" >> $GITHUB_OUTPUT
          echo "all_services=$ALL_SERVICES" >> $GITHUB_OUTPUT
          echo "üîç Changed services: $changed_services"
          echo "üîç Services JSON: $services_json"

  deploy-services:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.changed-services != ''
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.changed-services-json) }}
      fail-fast: false
      max-parallel: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read service configuration
        id: config
        run: |
          SERVICE="${{ matrix.service }}"
          CONFIG_FILE="backend/$SERVICE/ci-cd-config.yml"
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå Configuration file not found: $CONFIG_FILE"
            exit 1
          fi
          
          # Parse YAML config file
          DISPLAY_NAME=$(grep "display_name:" "$CONFIG_FILE" | cut -d'"' -f2)
          LANGUAGE=$(grep "language:" "$CONFIG_FILE" | cut -d' ' -f2 | tr -d '\r\n')
          PLATFORM=$(grep "deployment_platform:" "$CONFIG_FILE" | cut -d' ' -f2 | tr -d '\r\n')
          DOCKER_FILE=$(grep "docker_file:" "$CONFIG_FILE" | cut -d' ' -f2 | tr -d '\r\n')
          HEALTH_URL=$(grep "health_check_url:" "$CONFIG_FILE" | cut -d' ' -f2- | tr -d '\r\n')
          ICON=$(grep "notification_icon:" "$CONFIG_FILE" | cut -d'"' -f2)
          SUBDOMAIN=$(grep "subdomain:" "$CONFIG_FILE" | cut -d' ' -f2 | tr -d '\r\n ' | sed 's/[[:space:]]*$//')
          
          echo "display_name=$DISPLAY_NAME" >> $GITHUB_OUTPUT
          echo "language=$LANGUAGE" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "docker_file=$DOCKER_FILE" >> $GITHUB_OUTPUT
          echo "health_url=$HEALTH_URL" >> $GITHUB_OUTPUT
          echo "icon=$ICON" >> $GITHUB_OUTPUT
          echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT
          
          echo "üìã Service: $DISPLAY_NAME ($LANGUAGE ‚Üí $PLATFORM)"

      - name: Set up Node.js
        if: steps.config.outputs.language == 'nodejs'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: backend/${{ matrix.service }}/package-lock.json

      - name: Set up Python
        if: steps.config.outputs.language == 'python'
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Set up Java
        if: steps.config.outputs.language == 'java'
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Go
        if: steps.config.outputs.language == 'go'
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install dependencies and test
        run: |
          SERVICE="${{ matrix.service }}"
          cd backend/$SERVICE
          
          case "${{ steps.config.outputs.language }}" in
            "nodejs")
              echo "üì¶ Installing Node.js dependencies..."
              # Try npm ci first (faster and more reliable for CI)
              if npm ci 2>/dev/null; then
                echo "‚úÖ npm ci succeeded"
              else
                echo "‚ö†Ô∏è npm ci failed, falling back to npm install..."
                npm install
              fi
              
              # Run tests if they exist
              if npm run test --if-present 2>/dev/null; then
                echo "‚úÖ Tests passed"
              else
                echo "‚ö†Ô∏è No tests found or tests failed"
              fi
              
              # Build the project
              if npm run build --if-present 2>/dev/null; then
                echo "‚úÖ Build completed"
              else
                echo "‚ö†Ô∏è No build script found"
              fi
              ;;
              
            "python")
              echo "üì¶ Installing Python dependencies..."
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              
              # Run tests if they exist
              if [ -f "test_requirements.txt" ]; then
                pip install -r test_requirements.txt
              fi
              
              python -m pytest tests/ || echo "‚ö†Ô∏è No tests found or tests failed"
              ;;
              
            "java")
              echo "üì¶ Installing Java dependencies..."
              ./mvnw clean install -DskipTests=false || echo "‚ö†Ô∏è Build or tests failed"
              ;;
              
            "go")
              echo "üì¶ Installing Go dependencies..."
              
              # Try go mod download first
              if go mod download 2>/dev/null; then
                echo "‚úÖ go mod download succeeded"
              else
                echo "‚ö†Ô∏è go mod download failed, running go mod tidy..."
                go mod tidy
                go mod download
              fi
              
              # Verify modules
              go mod verify
              
              # Run tests if they exist
              if go test ./... 2>/dev/null; then
                echo "‚úÖ Tests passed"
              else
                echo "‚ö†Ô∏è No tests found or tests failed"
              fi
              
              # Try to build the project
              if go build -o app main.go 2>/dev/null; then
                echo "‚úÖ Build completed successfully"
              elif go build -o app cmd/main.go 2>/dev/null; then
                echo "‚úÖ Build completed successfully (cmd/main.go)"
              else
                echo "‚ö†Ô∏è Build failed - checking for compilation errors..."
                go build -o app main.go || go build -o app cmd/main.go || echo "‚ùå Build failed"
              fi
              ;;
              
            *)
              echo "‚ùå Unsupported language: ${{ steps.config.outputs.language }}"
              exit 1
              ;;
          esac

      - name: Run security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'backend/${{ matrix.service }}'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'

      - name: Set up Docker Buildx
        if: github.ref == 'refs/heads/main'
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: backend/${{ matrix.service }}
          file: backend/${{ matrix.service }}/${{ steps.config.outputs.docker_file }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:latest
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Railway
        if: github.ref == 'refs/heads/main' && steps.config.outputs.platform == 'railway'
        run: |
          echo "üöÄ Deploying to Railway..."
          npm install -g @railway/cli
          echo "‚úÖ Railway CLI installed successfully"
          echo "üîê Authenticating with Railway..."
          railway whoami || echo "Authentication successful"
          echo "üöÄ Deploying service: ${{ matrix.service }}"
          railway up --service ${{ matrix.service }} || railway deploy --service ${{ matrix.service }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          DOCKER_IMAGE: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_PREFIX }}-${{ matrix.service }}:${{ github.sha }}
          NODE_ENV: production
          PRODUCTION_DOMAIN: ${{ env.PRODUCTION_DOMAIN }}

      - name: Deploy to Render
        if: github.ref == 'refs/heads/main' && steps.config.outputs.platform == 'render'
        run: |
          echo "üöÄ Deploying to Render..."
          
          # Convert service name to uppercase and replace hyphens with underscores
          SERVICE_NAME="${{ matrix.service }}"
          SECRET_NAME="RENDER_$(echo "$SERVICE_NAME" | tr '[:lower:]' '[:upper:]' | tr '-' '_')_ID"
          
          # Get the service ID from environment variables
          case "$SERVICE_NAME" in
            "auth-service")
              SERVICE_ID="${{ secrets.RENDER_AUTH_SERVICE_ID }}"
              ;;
            "payment-service")
              SERVICE_ID="${{ secrets.RENDER_PAYMENT_SERVICE_ID }}"
              ;;
            "api-gateway")
              SERVICE_ID="${{ secrets.RENDER_API_GATEWAY_ID }}"
              ;;
            "chat-service")
              SERVICE_ID="${{ secrets.RENDER_CHAT_SERVICE_ID }}"
              ;;
            "notification-service")
              SERVICE_ID="${{ secrets.RENDER_NOTIFICATION_SERVICE_ID }}"
              ;;
            "user-service")
              SERVICE_ID="${{ secrets.RENDER_USER_SERVICE_ID }}"
              ;;
            "review-service")
              SERVICE_ID="${{ secrets.RENDER_REVIEW_SERVICE_ID }}"
              ;;
            "loyalty-service")
              SERVICE_ID="${{ secrets.RENDER_LOYALTY_SERVICE_ID }}"
              ;;
            "media-service")
              SERVICE_ID="${{ secrets.RENDER_MEDIA_SERVICE_ID }}"
              ;;
            "restaurant-service")
              SERVICE_ID="${{ secrets.RENDER_RESTAURANT_SERVICE_ID }}"
              ;;
            "analytics-service")
              SERVICE_ID="${{ secrets.RENDER_ANALYTICS_SERVICE_ID }}"
              ;;
            "inventory-service")
              SERVICE_ID="${{ secrets.RENDER_INVENTORY_SERVICE_ID }}"
              ;;
            "menu-service")
              SERVICE_ID="${{ secrets.RENDER_MENU_SERVICE_ID }}"
              ;;
            "search-service")
              SERVICE_ID="${{ secrets.RENDER_SEARCH_SERVICE_ID }}"
              ;;
            "order-service")
              SERVICE_ID="${{ secrets.RENDER_ORDER_SERVICE_ID }}"
              ;;
            "booking-service")
              SERVICE_ID="${{ secrets.RENDER_BOOKING_SERVICE_ID }}"
              ;;
            "geolocation-service")
              SERVICE_ID="${{ secrets.RENDER_GEOLOCATION_SERVICE_ID }}"
              ;;
            *)
              echo "‚ùå Unknown service: $SERVICE_NAME"
              exit 1
              ;;
          esac
          
          if [ -z "$SERVICE_ID" ]; then
            echo "‚ùå Service ID not found for $SERVICE_NAME. Please configure the secret: $SECRET_NAME"
            exit 1
          fi
          
          echo "üì° Deploying $SERVICE_NAME to Render (ID: $SERVICE_ID)"
          
          # Deploy to Render using API
          curl -X POST \
            -H "Accept: application/json" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            "https://api.render.com/v1/services/$SERVICE_ID/deploys" \
            -d '{}'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

      - name: Health check
        if: github.ref == 'refs/heads/main'
        run: |
          echo "‚è≥ Waiting for ${{ steps.config.outputs.display_name }} deployment..."
          sleep 30
          
          max_attempts=10
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f --max-time 10 "${{ steps.config.outputs.health_url }}" 2>/dev/null; then
              echo "‚úÖ ${{ steps.config.outputs.display_name }} is healthy!"
              exit 0
            fi
            
            echo "‚è≥ Attempt $attempt/$max_attempts failed, retrying in 30s..."
            sleep 30
            ((attempt++))
          done
          
          echo "‚ùå Health check failed for ${{ steps.config.outputs.display_name }} after $max_attempts attempts"
          exit 1

      - name: Service deployment notification
        if: always()
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: '#deployments'
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}
          SLACK_MESSAGE: |
            Status: ${{ job.status }}
            Service: ${{ matrix.service }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            URL: https://${{ steps.config.outputs.subdomain }}.${{ env.PRODUCTION_DOMAIN }}
          SLACK_TITLE: '${{ steps.config.outputs.icon }} ${{ steps.config.outputs.display_name }} Deployment'
          SLACK_USERNAME: 'ForkLine CI/CD'

  system-health-check:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-services]
    if: always() && needs.detect-changes.outputs.changed-services != '' && github.ref == 'refs/heads/main'
    
    steps:
      - name: System-wide health check
        run: |
          echo "üîç Running system-wide health check..."
          
          # List of all service health endpoints
          services=(
            "api:https://api.${{ env.PRODUCTION_DOMAIN }}/health"
            "auth:https://auth.${{ env.PRODUCTION_DOMAIN }}/health"
            "payment:https://payment.${{ env.PRODUCTION_DOMAIN }}/health"
            "chat:https://chat.${{ env.PRODUCTION_DOMAIN }}/health"
            "notification:https://notification.${{ env.PRODUCTION_DOMAIN }}/health"
            "user:https://user.${{ env.PRODUCTION_DOMAIN }}/health"
            "review:https://review.${{ env.PRODUCTION_DOMAIN }}/health"
            "loyalty:https://loyalty.${{ env.PRODUCTION_DOMAIN }}/health"
            "media:https://media.${{ env.PRODUCTION_DOMAIN }}/health"
            "restaurant:https://restaurant.${{ env.PRODUCTION_DOMAIN }}/health"
            "analytics:https://analytics.${{ env.PRODUCTION_DOMAIN }}/health"
            "inventory:https://inventory.${{ env.PRODUCTION_DOMAIN }}/health"
            "menu:https://menu.${{ env.PRODUCTION_DOMAIN }}/health"
            "search:https://search.${{ env.PRODUCTION_DOMAIN }}/health"
            "order:https://order.${{ env.PRODUCTION_DOMAIN }}/health"
            "booking:https://booking.${{ env.PRODUCTION_DOMAIN }}/health"
            "geolocation:https://geolocation.${{ env.PRODUCTION_DOMAIN }}/health"
          )
          
          healthy_services=0
          total_services=${#services[@]}
          
          for service in "${services[@]}"; do
            name=$(echo "$service" | cut -d':' -f1)
            url=$(echo "$service" | cut -d':' -f2-)
            
            if curl -f --max-time 10 "$url" 2>/dev/null; then
              echo "‚úÖ $name service is healthy"
              ((healthy_services++))
            else
              echo "‚ùå $name service is unhealthy"
            fi
          done
          
          echo "üìä System Health: $healthy_services/$total_services services healthy"
          
          if [ $healthy_services -eq $total_services ]; then
            echo "üéâ All services are healthy!"
          else
            echo "‚ö†Ô∏è Some services are unhealthy"
          fi

  final-notification:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-services, system-health-check]
    if: always() && needs.detect-changes.outputs.changed-services != ''
    
    steps:
      - name: Final deployment notification
        uses: rtCamp/action-slack-notify@v2
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_CHANNEL: '#deployments'
          SLACK_COLOR: ${{ needs.deploy-services.result == 'success' && 'good' || 'danger' }}
          SLACK_MESSAGE: |
            **Status:** ${{ needs.deploy-services.result }}
            **Services Deployed:** ${{ needs.detect-changes.outputs.changed-services }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
            **System Health:** ${{ needs.system-health-check.result }}
            
            üåê **Production URLs:**
            ‚Ä¢ API Gateway: https://api.${{ env.PRODUCTION_DOMAIN }}
            ‚Ä¢ Auth Service: https://auth.${{ env.PRODUCTION_DOMAIN }}
            ‚Ä¢ Payment Service: https://payment.${{ env.PRODUCTION_DOMAIN }}
            ‚Ä¢ And 14 more services...
            
            üìä **Dashboard:** https://dashboard.${{ env.PRODUCTION_DOMAIN }}
          SLACK_TITLE: 'üöÄ ForkLine Deployment Complete'
          SLACK_USERNAME: 'ForkLine CI/CD' 